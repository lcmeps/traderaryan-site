<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aryan Trading Journal — Aryan</title>

<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg1: #071428;
    --panel: rgba(255,255,255,0.95);
    --accent: linear-gradient(90deg,#00c6ff,#0072ff);
    --card:#f6fbff;
    --muted:#9aa3af;

    --success:#1e9b63;
    --danger:#dd4b39;
    --glass: rgba(255,255,255,0.9);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:#0b1220;
  }
  /* Subtle trading background */
  html,body{
    height:100%;margin:0;background:var(--bg1);
    background-image:
      linear-gradient(180deg, rgba(7,20,40,0.90), rgba(5,12,21,0.92)),
      url('https://images.unsplash.com/photo-1518183214770-9cffbec72538?auto=format&fit=crop&w=1600&q=80');
    background-size:cover;background-position:center;background-attachment:fixed;color:var(--card)
  }
  .wrap{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:16px;justify-content:space-between}
  header h1{margin:0;font-size:28px;color:white;letter-spacing:0.6px}
  header .sub{color:rgba(255,255,255,0.85);font-size:14px}
  /* Tabs */
  .tabs{display:flex;background:rgba(255,255,255,0.06);border-radius:12px;overflow:hidden;margin-top:18px}
  .tab{flex:1;padding:12px 16px;text-align:center;color:rgba(255,255,255,0.9);cursor:pointer;border-right:1px solid rgba(255,255,255,0.03)}
  .tab:last-child{border-right:0}
  .tab.active{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));font-weight:700}
  /* panels */
  .panel{display:none;margin-top:18px;background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .panel.active{display:block}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .card{background:white;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.15);color:#042024}
  .card h3{margin:0 0 8px 0}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  input[type=text], input[type=datetime-local], input[type=date], input[type=number], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);font-size:14px}
  textarea{min-height:80px;resize:vertical}
  button{background:linear-gradient(90deg,#00c6ff,#0072ff);color:white;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(2,6,23,0.06);color:var(--muted);font-weight:600}
  .row{display:flex;gap:10px}
  .row .col{flex:1}

  /* Journal styles */
  .year{margin-top:12px}
.year h2{color:#ffcc00}

  details{margin-top:8px}
#journalContent summary{color:#66ffcc;font-weight:700}

  .trade-card{background:linear-gradient(180deg,#ffffff,#f7fbff);padding:12px;border-radius:10px;margin:8px 0;display:grid;grid-template-columns:1fr 260px;gap:10px;align-items:start}
  .trade-meta{font-size:13px;color:#084;line-height:1.3}
  .trade-meta div{margin-bottom:6px}
  .trade-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .pl-pos{color:var(--success);font-weight:700}
  .pl-neg{color:var(--danger);font-weight:700}
  .screenshot{width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid rgba(2,6,23,0.06);cursor:pointer}
  .shot-strip{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
  .small{font-size:13px;color:#1e9090}

  .export-row{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}

  /* screenshot gallery (Screenshots tab) */
  .gallery-day{background:white;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.15);color:#042024;margin-bottom:12px}
  .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:8px}
  .thumb{border-radius:8px;overflow:hidden;position:relative;background:#fff;border:1px solid rgba(2,6,23,0.08)}
  .thumb img{width:100%;height:120px;object-fit:cover;display:block;cursor:pointer}
  .thumb .meta{position:absolute;left:6px;bottom:6px;padding:6px;background:rgba(0,0,0,0.55);color:white;border-radius:6px;font-size:12px}
  .thumb .del{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:6px;padding:4px 6px;font-size:12px;cursor:pointer}

  /* responsive */
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .trade-card{grid-template-columns:1fr} }
  footer{margin-top:14px;color:rgba(255,255,255,0.7);font-size:13px;text-align:center}

  /* dropzone + preview */
  .file-label{display:inline-block;padding:8px 10px;border-radius:8px;background:rgba(2,6,23,0.05);border:1px dashed rgba(2,6,23,0.14);cursor:pointer}
  .drop{border:2px dashed rgba(2,6,23,0.14);border-radius:10px;padding:10px;background:#fff}
  .drop.drag{background:#f0f9ff;border-color:#00c6ff}
  .shots-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .shot-item{position:relative;border:1px solid rgba(2,6,23,0.08);border-radius:8px;overflow:hidden;background:#fff}
  .shot-item img{width:130px;height:90px;object-fit:cover;display:block}
  .shot-item .x{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.5);color:#fff;border:0;border-radius:6px;padding:2px 6px;font-size:12px;cursor:pointer}
  .shot-item[draggable="true"]{cursor:grab}
  .summary-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Aryan Trading Journal</h1>
      <div class="sub">Personal trading dashboard — modern, offline, single-file</div>
    </div>
    <div class="small muted">Local-only storage • Click-to-send monthly report</div>
  </header>

  <!-- Tabs -->
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="dashboard">Dashboard</div>
    <div class="tab" data-tab="accounts">Accounts</div>
    <div class="tab" data-tab="trades">Trades (Add)</div>
    <div class="tab" data-tab="journal">Journal</div>
    <div class="tab" data-tab="news">Weekly News</div>
    <div class="tab" data-tab="reports">Reports</div>
    <div class="tab" data-tab="screenshots">Screenshots</div>
  </div>

  <!-- Dashboard -->
  <div class="panel active" id="panel-dashboard">
    <div class="grid">
      <div class="card">
        <h3>Accounts Overview</h3>
        <div id="accountsOverview" class="small muted">No accounts yet</div>
      </div>
      <div class="card">
        <h3>Quick Stats</h3>
        <div id="quickStats" class="small muted">—</div>
        <div style="height:180px;margin-top:12px"><canvas id="equityChart"></canvas></div>
      </div>
      <div class="card">
        <h3>Today</h3>
        <div id="todayStats" style="font-size:18px;font-weight:700">0 trades</div>
        <div class="small muted" id="todayList"></div>
        <div style="margin-top:10px" class="summary-row">
          <button onclick="openTab('journal'); showTodayInJournal()">View today's trades</button>
          <button class="ghost" onclick="exportAllCSV()">Export All CSV</button>
          <button class="ghost" onclick="exportAllXLSX()">Export All XLSX</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts -->
  <div class="panel" id="panel-accounts">
    <div class="card">
      <h3>Manage Accounts</h3>
      <div class="row">
        <div class="col"><input id="newAccountName" placeholder="Account name (e.g., Live-1, Demo)"></div>
        <div style="width:160px"><input id="newAccountStart" type="number" placeholder="Starting balance ($)"></div>
        <div style="width:120px"><button onclick="addAccount()">Add</button></div>
      </div>
      <div id="accountsList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Trades Add -->
  <div class="panel" id="panel-trades">
    <div class="card">
      <h3>Add / Edit Trade</h3>
      <form id="tradeForm">
        <div class="row">
          <div class="col"><label class="small">Entry time</label><input id="entryTime" type="datetime-local" required></div>
          <div class="col"><label class="small">Exit time</label><input id="exitTime" type="datetime-local"></div>
          <div style="width:200px"><label class="small">Account</label><select id="tradeAccount"></select></div>
        </div>

        <div class="row">
          <div class="col"><label class="small">Pair</label><input id="pair" type="text" placeholder="e.g., NAS100, EURUSD" required></div>
          <div style="width:160px"><label class="small">Side</label><select id="side"><option>Buy</option><option>Sell</option></select></div>
          <div style="width:200px"><label class="small">Type</label><select id="tradeType"><option>Continuation</option><option>Reversal</option></select></div>
        </div>

        <div class="row">
          <div class="col"><label class="small">Confluences (comma)</label><input id="confluences" type="text" placeholder="50EMA, S/R, fib"></div>
          <div style="width:200px"><label class="small">Strategy / Tags</label><input id="strategy" type="text" placeholder="momentum, pullback"></div>
        </div>

        <div class="row">
          <div class="col"><label class="small">Narrative (plan)</label><textarea id="narrative" placeholder="Your trade idea and plan..."></textarea></div>
          <div class="col"><label class="small">Mistakes realized</label><textarea id="mistakes" placeholder="What went wrong / what to improve..."></textarea></div>
        </div>

        <div class="row">
          <div class="col"><label class="small">Psychology (before/during)</label><textarea id="psychology" placeholder="Your state of mind..."></textarea></div>
          <div style="width:160px"><label class="small">RR (e.g., 1:3)</label><input id="rr" type="text"></div>
          <div style="width:180px"><label class="small">Profit / Loss ($)</label><input id="pl" type="number"></div>
        </div>

        <!-- DROPZONE + PREVIEW -->
        <div class="row" style="align-items:flex-start">
          <div class="col">
            <div id="shotDrop" class="drop">
              <div class="small muted">Drag & drop screenshots here (or click “Add images”). Reorder by dragging thumbnails, delete with ×.</div>
              <input id="screenshots" type="file" accept="image/*" multiple style="display:none">
              <div class="summary-row" style="margin-top:8px">
                <label class="file-label" onclick="document.getElementById('screenshots').click()">Add images</label>
                <span class="small muted" id="shotCount">0 image(s) selected</span>
              </div>
              <div id="shotPreview" class="shots-preview"></div>
            </div>
          </div>
          <div style="width:140px"><label class="small">Result</label><select id="result"><option>Win</option><option>Loss</option><option>BE</option></select></div>
          <div style="width:120px"><button type="submit" id="saveBtn">Save Trade</button></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Journal -->
  <div class="panel" id="panel-journal">
    <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0; color:#00c6ff">Journal (Year → Month → Day)</h3>

      <div>
        <select id="journalAccountFilter" onchange="renderJournal(true)"></select>
        <button class="ghost" onclick="exportMonthCSV()">Export Month CSV</button>
        <button class="ghost" onclick="exportMonthXLSX()">Export Month XLSX</button>
      </div>
    </div>

    <div id="journalContent" style="margin-top:12px"></div>
  </div>

  <!-- Weekly News -->
  <div class="panel" id="panel-news">
    <div class="card">
      <h3>Weekly News / Notes</h3>
      <form id="newsForm">
        <div class="row">
          <div class="col"><input id="newsDate" type="date" value=""></div>
          <div style="width:140px"><label class="file-label">Upload image<input id="newsImg" type="file" accept="image/*" style="display:none"></label></div>
        </div>
        <div style="margin-top:8px"><textarea id="newsText" placeholder="Write weekly notes..."></textarea></div>
        <div style="margin-top:8px"><button type="submit">Add News</button></div>
      </form>
    </div>
    <div id="newsList" style="margin-top:12px"></div>
  </div>

  <!-- Reports -->
  <div class="panel" id="panel-reports">
    <div class="card">
      <h3>Monthly Report</h3>
      <div class="small muted">Click to generate the monthly summary and open your email client to send the report.</div>
      <div style="margin-top:12px" class="row">
        <div class="col"><select id="reportAccount"></select></div>
        <div style="width:160px"><input id="reportMonth" type="month"></div>
        <div style="width:140px"><button onclick="openMonthlyReport()">Generate & Open Email</button></div>
      </div>
    </div>
  </div>

  <!-- Screenshots -->
  <div class="panel" id="panel-screenshots">
    <h3>Screenshots (grouped by day)</h3>
    <div id="screenshotDays" style="margin-top:12px"></div>
  </div>

  <footer>Saved locally in your browser • You can export CSV / XLSX • Images stored locally (Base64)</footer>
</div>

<!-- Modal for image preview -->
<div id="imgModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center">
  <div style="max-width:90%;max-height:90%;background:white;padding:8px;border-radius:8px">
    <img id="modalImg" src="" style="max-width:100%;max-height:80vh;display:block;border-radius:6px">
    <div id="modalMeta" class="small muted" style="margin-top:8px"></div>
    <div style="text-align:right;margin-top:8px"><button onclick="closeModal()" class="ghost">Close</button></div>
  </div>
</div>

<script>
/* ========= App Data ========= */
const STORAGE_KEYS = {
  ACCOUNTS: 'aj_accounts_v1',
  TRADES: 'aj_trades_v2',   // bump version to avoid conflicts with older structure
  NEWS: 'aj_news_v1'
};
/* ========= App Data ========= */
let accounts = [];
let trades = [];
let news = [];

// Backend API URL
const API_URL = '/.netlify/functions/save';

// Load everything from backend
async function loadAll() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    accounts = data.accounts || [];
    trades = data.trades || [];
    news = data.news || [];
    console.log("Loaded from backend:", data);

// Update UI with fresh data
renderAccounts();
renderTrades();
renderNews();

  } catch (err) {
    console.error("Error loading data:", err);
  }<!-- ... keep your full HTML and CSS the same ... -->

<script>
/* ========= App Data ========= */
let accounts = [];
let trades = [];
let news = [];

// Backend API URL
const API_URL = '/.netlify/functions/save';

// Load everything from backend
async function loadAll() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    accounts = data.accounts || [];
    trades = data.trades || [];
    news = data.news || [];

    // Update UI
    renderAccounts();
    renderTrades();
    renderNews();
  } catch (err) {
    console.error("Error loading data:", err);
  }
}

// Save everything to backend
async function saveAll() {
  try {
    const data = { accounts, trades, news };
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
  } catch (err) {
    console.error("Error saving data:", err);
  }
}

// Load data on page startup
loadAll();

/* ========= Accounts ========= */
function addAccount(){
  const name = document.getElementById('newAccountName').value.trim();
  const start = Number(document.getElementById('newAccountStart').value || 0);
  if(!name) return alert('Enter account name');
  accounts.push({ id: uid('acc_'), name, startBalance: start, createdAt: new Date().toISOString() });
  saveAll();
  document.getElementById('newAccountName').value='';
  document.getElementById('newAccountStart').value='';
  populateTradeAccounts(); renderAccounts(); renderDashboard(); populateReportAccounts(); ensureJournalFilter(); renderJournal(true);
}
function editAccount(id){
  const a = accounts.find(x=>x.id===id);
  if(!a) return;
  const newName = prompt('Account name', a.name);
  if(newName) a.name = newName;
  saveAll(); populateTradeAccounts(); renderAccounts(); renderDashboard(); ensureJournalFilter(); renderJournal(true); populateReportAccounts();
}
function deleteAccount(id){
  if(!confirm('Delete this account and its trades?')) return;
  accounts = accounts.filter(x=>x.id!==id);
  trades = trades.filter(t=>t.accountId!==id);
  saveAll(); populateTradeAccounts(); renderAccounts(); renderDashboard(); ensureJournalFilter(); renderJournal(true); populateReportAccounts();
}

/* ========= Trades ========= */
document.getElementById('tradeForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const accId = document.getElementById('tradeAccount').value;
  if(!accId) return alert('Select an account');

  const entryISO = document.getElementById('entryTime').value || new Date().toISOString().slice(0,16);
  const tData = {
    accountId: accId,
    pair: document.getElementById('pair').value.trim(),
    entryTime: entryISO,
    exitTime: document.getElementById('exitTime').value || '',
    side: document.getElementById('side').value,
    tradeType: document.getElementById('tradeType').value,
    confluences: document.getElementById('confluences').value.trim(),
    strategy: document.getElementById('strategy').value.trim(),
    narrative: document.getElementById('narrative').value.trim(),
    mistakes: document.getElementById('mistakes').value.trim(),
    psychology: document.getElementById('psychology').value.trim(),
    rr: document.getElementById('rr').value.trim(),
    pl: Number(document.getElementById('pl').value || 0),
    result: document.getElementById('result').value,
    screenshots: currentShots.slice(),
    screenshot: currentShots[0] || '',
  };

  if(editingTradeId){
    const tr = trades.find(x=>x.id===editingTradeId);
    if(!tr) return alert('Trade not found');
    Object.assign(tr, tData);
    saveAll();
    editingTradeId = null;
    document.getElementById('saveBtn').textContent = 'Save Trade';
    alert('Trade updated.');
  } else {
    const t = { id: uid('tr_'), createdAt: new Date().toISOString(), ...tData };
    trades.push(t);
    saveAll();
    alert('Saved trade.');
  }

  e.target.reset();
  initDropzone([]);
  renderDashboard();
  ensureJournalFilter();
  renderJournal(true);
  renderScreenshotsByDay();
});
function deleteTrade(id){
  if(!confirm('Delete trade?')) return;
  trades = trades.filter(t=>t.id!==id);
  saveAll();
  ensureJournalFilter();
  renderJournal(true);
  renderDashboard();
  renderScreenshotsByDay();
}

/* ========= News ========= */
document.getElementById('newsForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const d = document.getElementById('newsDate').value || new Date().toISOString().slice(0,10);
  const txt = document.getElementById('newsText').value.trim();
  let img = '';
  const file = document.getElementById('newsImg').files[0];
  if(file) img = await toBase64(file);
  news.push({ id: uid('nw_'), date: d, text: txt, img });
  saveAll(); // <-- added here
  document.getElementById('newsForm').reset(); 
  renderNews();
});
function deleteNews(id){ 
  news = news.filter(n=>n.id!==id); 
  saveAll(); 
  renderNews(); 
}

/* ========= Init ========= */
(function init(){
  populateTradeAccounts();
  ensureJournalFilter();
  renderAccounts();
  renderDashboard();
  renderJournal(true);
  renderNews();
  renderScreenshotsByDay();
  populateReportAccounts();
  initDropzone([]);
})();
</script>

}

// Save everything to backend
async function saveAll() {
  try {
    const data = { accounts, trades, news };
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    console.log("Saved to backend");
  } catch (err) {
    console.error("Error saving data:", err);
  }
}

// Load data on page startup
loadAll();

function formatDateTime(d){
  if(!d) return '';
  const dt = new Date(d);
  return isNaN(dt) ? '' : dt.toLocaleString();
}
function minutesBetween(a,b){
  const A=new Date(a), B=new Date(b);
  if(isNaN(A)||isNaN(B)) return null;
  return (B - A) / 60000;
}
function hmsFromMinutes(mins){
  if(mins===null) return '';
  const m = Math.round(mins);
  const h = Math.floor(m/60);
  const r = m%60;
  return (h>0? h+'h ':'') + r + 'm';
}
function dateKeyFromISO(iso){
  const d = new Date(iso);
  if(isNaN(d)) return null;
  return d.toISOString().slice(0,10);
}

/* ======== Tab navigation ======== */
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  if(tab === 'dashboard'){ renderDashboard(); }
  if(tab === 'journal'){ ensureJournalFilter(); renderJournal(true); }
  if(tab === 'accounts'){ renderAccounts(); }
  if(tab === 'trades'){ populateTradeAccounts(); initDropzone(); }
  if(tab === 'news'){ renderNews(); }
  if(tab === 'reports'){ populateReportAccounts(); }
  if(tab === 'screenshots'){ renderScreenshotsByDay(); }
}));
function openTab(tab){ document.querySelector(`.tab[data-tab="${tab}"]`).click(); }

/* ========= Accounts ========= */
function addAccount(){
  const name = document.getElementById('newAccountName').value.trim();
  const start = Number(document.getElementById('newAccountStart').value || 0);
  if(!name) return alert('Enter account name');
  accounts.push({ id: uid('acc_'), name, startBalance: start, createdAt: new Date().toISOString() });
  saveAll();
  document.getElementById('newAccountName').value='';
  document.getElementById('newAccountStart').value='';
  populateTradeAccounts(); renderAccounts(); renderDashboard(); populateReportAccounts(); ensureJournalFilter(); renderJournal(true);
}
function renderAccounts(){
  const el = document.getElementById('accountsList'); el.innerHTML='';
  if(accounts.length===0){ el.innerHTML='<div class="small muted">No accounts yet.</div>'; return; }
  accounts.forEach((a)=>{
    const accTrades = trades.filter(t=>t.accountId === a.id);
    const wins = accTrades.filter(t=>t.result==='Win').length;
    const total = accTrades.length;
    const cumPL = accTrades.reduce((s,t)=>s + (Number(t.pl)||0), 0);
    const currentBal = (Number(a.startBalance)||0) + cumPL;
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<h3>${a.name}</h3>
      <div class="small muted">
        Start: $${(a.startBalance||0).toFixed(2)} • Trades: ${total} • Wins: ${wins}
        • Winrate: ${total?((wins/total)*100).toFixed(1)+'%':'0%'}
        • Cum P/L: $${cumPL.toFixed(2)} • <strong>Current Balance: $${currentBal.toFixed(2)}</strong>
      </div>
      <div style="margin-top:10px"><button onclick="editAccount('${a.id}')">Edit</button> <button class="ghost" onclick="deleteAccount('${a.id}')">Delete</button></div>`;
    el.appendChild(card);
  });
}
function editAccount(id){
  const a = accounts.find(x=>x.id===id);
  if(!a) return;
  const newName = prompt('Account name', a.name);
  if(newName) a.name = newName;
  saveAll(); populateTradeAccounts(); renderAccounts(); renderDashboard(); ensureJournalFilter(); renderJournal(true); populateReportAccounts();
}
function deleteAccount(id){
  if(!confirm('Delete this account and its trades?')) return;
  accounts = accounts.filter(x=>x.id!==id);
  trades = trades.filter(t=>t.accountId!==id);
  saveAll(); populateTradeAccounts(); renderAccounts(); renderDashboard(); ensureJournalFilter(); renderJournal(true); populateReportAccounts();
}
function populateTradeAccounts(){
  const sel = document.getElementById('tradeAccount');
  sel.innerHTML='';
  if(!accounts.length){ sel.innerHTML='<option value="">-- no accounts --</option>'; return; }
  accounts.forEach(a => { sel.innerHTML += `<option value="${a.id}">${a.name}</option>`; });
}

/* ========= Journal filter (default All) ========= */
function ensureJournalFilter(){
  const jf = document.getElementById('journalAccountFilter');
  if(!jf) return;
  const prev = jf.value;
  jf.innerHTML = '<option value="all">All accounts</option>' + accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  jf.value = (prev && [...jf.options].some(o=>o.value===prev)) ? prev : 'all';
}
function getJournalSelectedAccountId(){
  const jf = document.getElementById('journalAccountFilter');
  const v = jf?.value || 'all';
  return v==='all' ? null : v;
}

/* ========= Dropzone & screenshot state ========= */
let currentShots = [];
let editingTradeId = null;

function initDropzone(existing=[]) {
  currentShots = Array.isArray(existing) ? existing.slice() : [];
  updateShotPreview();

  const dz = document.getElementById('shotDrop');
  const input = document.getElementById('screenshots');

  input.onchange = async (e)=>{
    if(!e.target.files?.length) return;
    const imgs = await Promise.all([...e.target.files].map(f=>toBase64(f)));
    currentShots.push(...imgs);
    updateShotPreview();
    input.value = '';
  };

  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); dz.classList.add('drag');}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); dz.classList.remove('drag');}));
  dz.addEventListener('drop', async (e)=>{
    const files = [...e.dataTransfer.files].filter(f=>/^image\//.test(f.type));
    if(!files.length) return;
    const imgs = await Promise.all(files.map(f=>toBase64(f)));
    currentShots.push(...imgs);
    updateShotPreview();
  });
}
function updateShotPreview(){
  const cont = document.getElementById('shotPreview');
  const count = document.getElementById('shotCount');
  cont.innerHTML = '';
  count.textContent = `${currentShots.length} image(s) selected`;

  currentShots.forEach((src, i)=>{
    const item = document.createElement('div');
    item.className = 'shot-item';
    item.draggable = true;
    item.dataset.index = i;

    const img = document.createElement('img');
    img.src = src;

    const del = document.createElement('button');
    del.className = 'x';
    del.textContent = '×';
    del.title = 'Remove';
    del.onclick = ()=>{ currentShots.splice(i,1); updateShotPreview(); };

    item.addEventListener('dragstart', (e)=> { e.dataTransfer.setData('text/plain', i.toString()); });
    item.addEventListener('dragover', (e)=> e.preventDefault());
    item.addEventListener('drop', (e)=>{
      e.preventDefault();
      const from = Number(e.dataTransfer.getData('text/plain'));
      const to = i;
      if(Number.isInteger(from) && from!==to){
        const [moved] = currentShots.splice(from,1);
        currentShots.splice(to,0,moved);
        updateShotPreview();
      }
    });

    item.appendChild(img);
    item.appendChild(del);
    cont.appendChild(item);
  });
}

/* ========= Trades - Add & Save / Edit ========= */
document.getElementById('tradeForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const accId = document.getElementById('tradeAccount').value;
  if(!accId) return alert('Select an account');

  // guarantee entryTime exists
  const entryISO = document.getElementById('entryTime').value || new Date().toISOString().slice(0,16);
  const tData = {
    accountId: accId,
    pair: document.getElementById('pair').value.trim(),
    entryTime: entryISO,
    exitTime: document.getElementById('exitTime').value || '',
    side: document.getElementById('side').value,
    tradeType: document.getElementById('tradeType').value,
    confluences: document.getElementById('confluences').value.trim(),
    strategy: document.getElementById('strategy').value.trim(),
    narrative: document.getElementById('narrative').value.trim(),
    mistakes: document.getElementById('mistakes').value.trim(),
    psychology: document.getElementById('psychology').value.trim(),
    rr: document.getElementById('rr').value.trim(),
    pl: Number(document.getElementById('pl').value || 0),
    result: document.getElementById('result').value,
    screenshots: currentShots.slice(),
    screenshot: currentShots[0] || '',
  };

  if(editingTradeId){
    const tr = trades.find(x=>x.id===editingTradeId);
    if(!tr) return alert('Trade not found');
    Object.assign(tr, tData);
    saveAll();
    editingTradeId = null;
    document.getElementById('saveBtn').textContent = 'Save Trade';
    alert('Trade updated.');
  } else {
    const t = { id: uid('tr_'), createdAt: new Date().toISOString(), ...tData };
    trades.push(t);
    saveAll();
    alert('Saved trade.');
  }

  e.target.reset();
  initDropzone([]); // clear previews

  renderDashboard();
  ensureJournalFilter();
  renderJournal(true);
  renderScreenshotsByDay();
});

/* ========= Journal (Year > Month > Day) ========= */
function renderJournal(forceOpenToday=false){
  const container = document.getElementById('journalContent');
  const selectedId = getJournalSelectedAccountId();

  // normalize trades (ensure entryTime and screenshots array)
  trades.forEach(t=>{
    if(!t.entryTime || isNaN(new Date(t.entryTime))) t.entryTime = t.createdAt || new Date().toISOString();
    if(!Array.isArray(t.screenshots) && t.screenshot){ t.screenshots = [t.screenshot]; }
    if(!Array.isArray(t.screenshots)) t.screenshots = [];
  });

  let list = trades.slice().sort((a,b)=> new Date(b.entryTime) - new Date(a.entryTime));
  if(selectedId) list = list.filter(t=>t.accountId === selectedId);

  const grouped = {};
  list.forEach(t=>{
    const d = new Date(t.entryTime);
    if(isNaN(d)) return;
    const y = d.getFullYear();
    const m = d.toLocaleString('default',{month:'long'});
    const dayKey = d.toISOString().slice(0,10);
    (grouped[y] ??= {}); (grouped[y][m] ??= {}); (grouped[y][m][dayKey] ??= []).push(t);
  });

  container.innerHTML = '';
  if(Object.keys(grouped).length===0){
    container.innerHTML = '<div class="small muted">No trades yet.</div>';
    return;
  }

  for(const year of Object.keys(grouped).sort((a,b)=>b-a)){
    const yearDiv = document.createElement('div'); yearDiv.className='year';
    yearDiv.innerHTML = `<h2>${year}</h2>`;
    for(const month of Object.keys(grouped[year]).sort((a,b)=> new Date(b+' 1') - new Date(a+' 1'))){
      const monthSection = document.createElement('div');
      const monthId = uid('mon');
      monthSection.innerHTML = `<details open><summary style="font-size:18px">${month}</summary><div class="small muted" id="${monthId}-meta"></div><div id="${monthId}-days"></div></details>`;
      yearDiv.appendChild(monthSection);

      const daysContainer = monthSection.querySelector(`#${monthId}-days`);
      const days = grouped[year][month];
      let monthTotalPL = 0, monthCount=0, monthDurations=[];
      for(const dayKey of Object.keys(days).sort((a,b)=> new Date(b) - new Date(a))){
        const dayTrades = days[dayKey];
        const dayDiv = document.createElement('details'); dayDiv.open = false;
        const d = new Date(dayKey);
        dayDiv.innerHTML = `<summary style="font-weight:700">${d.toLocaleDateString()}</summary>`;
        const dayContent = document.createElement('div');

        let dayTotal = 0; let dayCount = 0; let dayDurations = [];
        dayTrades.forEach(tr => {
          const accName = accounts.find(a=>a.id===tr.accountId)?.name || '';
          const durMins = (tr.entryTime && tr.exitTime) ? minutesBetween(tr.entryTime, tr.exitTime) : null;
          if(durMins !== null && !isNaN(durMins)) { dayDurations.push(durMins); monthDurations.push(durMins); }
          dayTotal += Number(tr.pl || 0); monthTotalPL += Number(tr.pl || 0);
          dayCount++; monthCount++;

          const card = document.createElement('div'); card.className='trade-card';
          const left = document.createElement('div'); left.className='trade-meta';
          left.innerHTML = `
            <div><strong>${tr.pair}</strong> • ${tr.side} • ${tr.tradeType}</div>
            <div class="small">Account: ${accName || '-'}</div>
            <div class="small">Entry: ${formatDateTime(tr.entryTime)} ${tr.exitTime?'<br>Exit: '+formatDateTime(tr.exitTime):''}</div>
            <div class="small">RR: ${tr.rr || '-'}</div>
            <div class="small">Strategy: ${tr.strategy || '-'} • Confluences: ${tr.confluences || '-'}</div>
            <div class="small">Narrative: ${tr.narrative || '-'}</div>
            <div class="small">Mistakes: ${tr.mistakes || '-'}</div>
            <div class="small">Psychology: ${tr.psychology || '-'}</div>`;

          const right = document.createElement('div'); right.className='trade-right small';
          const shotsHTML = (tr.screenshots?.length)
            ? `<div class="shot-strip">` + tr.screenshots.map((s,idx)=>`<img src="${s}" class="screenshot" title="Screenshot ${idx+1}" onclick="openModal('${tr.id}', ${idx})">`).join('') + `</div>`
            : '';

          const durText = (tr.entryTime && tr.exitTime) ? hmsFromMinutes(minutesBetween(tr.entryTime,tr.exitTime)) : '-';
          right.innerHTML = `
            <div>PL: <span class="${(tr.pl||0)>=0 ? 'pl-pos' : 'pl-neg'}">$${(tr.pl||0).toFixed(2)}</span></div>
            <div>Dur: ${durText}</div>
            <div>Result: ${tr.result}</div>
            ${shotsHTML}
            <div style="margin-top:8px">
              <button class="ghost" onclick="startEditTrade('${tr.id}')">Edit</button>
              <button class="ghost" onclick="deleteTrade('${tr.id}')">Delete</button>
            </div>`;

          card.appendChild(left); card.appendChild(right);
          dayContent.appendChild(card);
        });

        const avgDur = dayDurations.length ? (dayDurations.reduce((a,b)=>a+b,0)/dayDurations.length) : null;
        const statsDiv = document.createElement('div'); statsDiv.className='small muted';
        statsDiv.innerHTML = `<div style="margin:8px 0"><strong>Day summary:</strong> Trades: ${dayCount} • Day P/L: $${dayTotal.toFixed(2)} • Avg duration: ${avgDur ? hmsFromMinutes(avgDur) : '-'} </div>`;
        dayContent.appendChild(statsDiv);
        dayDiv.appendChild(dayContent);
        daysContainer.appendChild(dayDiv);
      }

      const monthMeta = monthSection.querySelector(`#${monthId}-meta`);
      const monthAvgDur = monthDurations.length ? (monthDurations.reduce((a,b)=>a+b,0)/monthDurations.length) : null;
      const monthTradesCount = monthCount;
      const monthWins = Object.values(days).flat().filter(t=>t.result==='Win').length;
      const monthWR = monthTradesCount ? ((monthWins/monthTradesCount)*100).toFixed(1) : '0';
      monthMeta.innerHTML = `Total trades: ${monthTradesCount} • Month P/L: $${monthTotalPL.toFixed(2)} • Win rate: ${monthWR}% • Avg trade duration: ${monthAvgDur ? hmsFromMinutes(monthAvgDur) : '-'}`;

      const exportRow = document.createElement('div'); exportRow.className='export-row';
      exportRow.innerHTML = `<button class="ghost" onclick="exportSelectedMonthCSV('${year}','${month}')">Export ${month} CSV</button>
        <button class="ghost" onclick="exportSelectedMonthXLSX('${year}','${month}')">Export ${month} XLSX</button>`;
      monthSection.appendChild(exportRow);
    }
    container.appendChild(yearDiv);
  }

  if(forceOpenToday){
    const todayText = new Date().toLocaleDateString();
    document.querySelectorAll('#journalContent details > summary').forEach(s=>{
      if(s.textContent.trim()===todayText){ s.parentElement.open = true; }
    });
  }
}

/* Begin edit */
function startEditTrade(id){
  const tr = trades.find(t=>t.id===id);
  if(!tr) return alert('Trade not found');

  openTab('trades');
  setTimeout(()=>{
    document.getElementById('tradeAccount').value = tr.accountId;
    document.getElementById('entryTime').value = tr.entryTime;
    document.getElementById('exitTime').value = tr.exitTime || '';
    document.getElementById('pair').value = tr.pair;
    document.getElementById('side').value = tr.side;
    document.getElementById('tradeType').value = tr.tradeType;
    document.getElementById('confluences').value = tr.confluences || '';
    document.getElementById('strategy').value = tr.strategy || '';
    document.getElementById('narrative').value = tr.narrative || '';
    document.getElementById('mistakes').value = tr.mistakes || '';
    document.getElementById('psychology').value = tr.psychology || '';
    document.getElementById('rr').value = tr.rr || '';
    document.getElementById('pl').value = tr.pl || 0;
    document.getElementById('result').value = tr.result || 'BE';

    const arr = Array.isArray(tr.screenshots) ? tr.screenshots : (tr.screenshot ? [tr.screenshot] : []);
    editingTradeId = tr.id;
    document.getElementById('saveBtn').textContent = 'Update Trade';
    initDropzone(arr);
  }, 120);
}

function deleteTrade(id){
  if(!confirm('Delete trade?')) return;
  trades = trades.filter(t=>t.id!==id);
  saveAll();
  ensureJournalFilter();
  renderJournal(true);
  renderDashboard();
  renderScreenshotsByDay();
}

/* ========= Screenshots (grouped by day + delete) ========= */
function renderScreenshotsByDay(){
  const host = document.getElementById('screenshotDays'); host.innerHTML = '';

  const map = {}; // dayKey -> items
  trades.forEach((tr)=>{
    const shots = Array.isArray(tr.screenshots) ? tr.screenshots : (tr.screenshot ? [tr.screenshot] : []);
    const key = dateKeyFromISO(tr.entryTime || tr.createdAt);
    if(!key) return;
    shots.forEach((img, idx)=>{
      if(!img) return;
      (map[key] ??= []).push({
        tradeId: tr.id,
        imgIndex: idx,
        img,
        pair: tr.pair,
        entryTime: tr.entryTime,
        accountName: accounts.find(a=>a.id===tr.accountId)?.name || ''
      });
    });
  });

  const dayKeys = Object.keys(map).sort((a,b)=> new Date(b) - new Date(a));
  if(dayKeys.length===0){
    host.innerHTML = '<div class="small muted">No screenshots yet.</div>';
    return;
  }

  dayKeys.forEach(key=>{
    const section = document.createElement('div');
    section.className = 'gallery-day';
    const d = new Date(key);
    section.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">${d.toLocaleDateString()}</h3>
      <div class="small muted">${map[key].length} screenshot(s)</div>
    </div>
    <div class="gallery-grid" id="grid-${key}"></div>`;
    host.appendChild(section);

    const grid = section.querySelector(`#grid-${CSS.escape(key)}`);
    map[key].sort((a,b)=> new Date(b.entryTime) - new Date(a.entryTime)).forEach(item=>{
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `
        <img src="${item.img}" alt="shot">
        <div class="meta">${item.pair}${item.accountName? ' • '+item.accountName:''}<br>${formatDateTime(item.entryTime)}</div>
        <button class="del" title="Delete screenshot">Delete</button>
      `;
      // zoom
      div.querySelector('img').addEventListener('click', ()=> openModal(item.tradeId, item.imgIndex));

      // delete screenshot handler (edits the trade + save)
      div.querySelector('.del').addEventListener('click', ()=>{
        const tr = trades.find(t=>t.id===item.tradeId);
        if(!tr) return;
        if(!Array.isArray(tr.screenshots)) tr.screenshots = tr.screenshot ? [tr.screenshot] : [];
        if(!confirm('Delete this screenshot from the trade?')) return;
        tr.screenshots.splice(item.imgIndex, 1);
        tr.screenshot = tr.screenshots[0] || ''; // sync legacy first image
        saveAll();
        renderScreenshotsByDay();
        renderJournal(); // thumbnails appear in journal too
      });

      grid.appendChild(div);
    });
  });
}

/* Image modal */
function openModal(tradeId, idx=0){
  const t = trades.find(x=>x.id===tradeId);
  if(!t) return;
  const arr = Array.isArray(t.screenshots) ? t.screenshots : (t.screenshot? [t.screenshot] : []);
  const img = arr[idx] || arr[0] || '';
  document.getElementById('modalImg').src = img;
  document.getElementById('modalMeta').innerText = `${t.pair} • ${t.side} • ${formatDateTime(t.entryTime)} ${t.exitTime?(' → '+formatDateTime(t.exitTime)) : ''} • PL: $${(t.pl||0).toFixed(2)}`;
  document.getElementById('imgModal').style.display = 'flex';
}
function closeModal(){ document.getElementById('imgModal').style.display='none'; }

/* ========= Reports (mailto) ========= */
function openMonthlyReport(){
  const accId = document.getElementById('reportAccount').value;
  const ym = document.getElementById('reportMonth').value;
  if(!accId || !ym) return alert('Select account and month');
  const [year,month] = ym.split('-');
  const repTrades = trades.filter(t => {
    const dt = new Date(t.entryTime);
    return t.accountId === accId && dt.getFullYear() === Number(year) && (dt.getMonth()+1) === Number(month);
  });
  let report = `Aryan Trading Journal Report — ${year}-${month}\nAccount: ${accounts.find(a=>a.id===accId).name}\n\n`;
  repTrades.forEach(t => {
    const dur = (t.entryTime && t.exitTime) ? hmsFromMinutes(minutesBetween(t.entryTime,t.exitTime)) : '-';
    report += `${formatDateTime(t.entryTime)} | ${t.pair} | ${t.side} | PL: $${(t.pl||0).toFixed(2)} | Dur: ${dur} | Notes: ${t.narrative}\n`;
  });
  const subject = encodeURIComponent(`Trading Report ${accounts.find(a=>a.id===accId).name} ${year}-${month}`);
  const body = encodeURIComponent(report);
  window.open(`mailto:aryanlamichhane11111@gmail.com?subject=${subject}&body=${body}`,'_blank');
}

/* ========= Export helpers ========= */
function flattenTrade(t){
  return {
    id: t.id,
    account: (accounts.find(a=>a.id===t.accountId) || {}).name || '',
    pair: t.pair,
    entryTime: t.entryTime,
    exitTime: t.exitTime,
    side: t.side,
    tradeType: t.tradeType,
    strategy: t.strategy,
    confluences: t.confluences,
    pl: t.pl,
    result: t.result,
    duration_minutes: (t.entryTime && t.exitTime) ? Math.round(minutesBetween(t.entryTime,t.exitTime)) : ''
  };
}
function tradesToCSV(arr){
  const headers = ['id','account','pair','entryTime','exitTime','side','tradeType','strategy','confluences','pl','result','duration_minutes'];
  const rows = arr.map(t => headers.map(h=> `"${String((flattenTrade(t))[h] ?? '').replace(/"/g,'""')}"`).join(','));
  return `"${headers.join('","')}"\n` + rows.join('\n');
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function exportAllCSV(){ if(!trades.length) return alert('No trades to export'); downloadBlob(tradesToCSV(trades),'trades_all.csv','text/csv;charset=utf-8;'); }
function exportAllXLSX(){ if(!trades.length) return alert('No trades to export'); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(trades.map(flattenTrade)); XLSX.utils.book_append_sheet(wb,ws,'Trades'); XLSX.writeFile(wb,'trades_all.xlsx'); }
function exportMonthCSV(){ const now=new Date(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==now.getFullYear()&&new Date(t.entryTime).getMonth()==now.getMonth()); if(!arr.length) return alert('No trades in this month'); downloadBlob(tradesToCSV(arr),`trades_${now.getFullYear()}_${now.getMonth()+1}.csv`,'text/csv;charset=utf-8;'); }
function exportMonthXLSX(){ const now=new Date(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==now.getFullYear()&&new Date(t.entryTime).getMonth()==now.getMonth()); if(!arr.length) return alert('No trades in this month'); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(arr.map(flattenTrade)); XLSX.utils.book_append_sheet(wb,ws,'MonthTrades'); XLSX.writeFile(wb,`trades_${now.getFullYear()}_${now.getMonth()+1}.xlsx`); }
function exportSelectedMonthCSV(year, monthName){ const mi=new Date(`${monthName} 1`).getMonth(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==year&&new Date(t.entryTime).getMonth()==mi); if(!arr.length) return alert('No trades for that month'); downloadBlob(tradesToCSV(arr),`trades_${year}_${mi+1}.csv`,'text/csv;charset=utf-8;'); }
function exportSelectedMonthXLSX(year, monthName){ const mi=new Date(`${monthName} 1`).getMonth(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==year&&new Date(t.entryTime).getMonth()==mi); if(!arr.length) return alert('No trades for that month'); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(arr.map(flattenTrade)); XLSX.utils.book_append_sheet(wb,ws,'MonthTrades'); XLSX.writeFile(wb,`trades_${year}_${mi+1}.xlsx`); }

/* ========= Utility: Base64 file reader ========= */
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ========= Dashboard ========= */
function renderDashboard(){
  // accounts overview
  const accOverview = document.getElementById('accountsOverview'); accOverview.innerHTML='';
  if(!accounts.length){
    accOverview.innerHTML='<div class="small muted">No accounts yet. Add one in Accounts tab.</div>';
  } else {
    accounts.forEach(a=>{
      const accTrades = trades.filter(t=>t.accountId === a.id);
      const wins = accTrades.filter(t=>t.result==='Win').length;
      const total = accTrades.length;
      const cum = accTrades.reduce((s,t)=>s + (Number(t.pl)||0), 0);
      const bal = (Number(a.startBalance)||0) + cum;
      accOverview.innerHTML += `<div class="card" style="margin-bottom:8px"><h3>${a.name}</h3><div class="small muted">Start: $${(a.startBalance||0).toFixed(2)} • Trades: ${total} • Wins: ${wins} • Win rate: ${total?((wins/total)*100).toFixed(1)+'%':'0%'} • Cum P/L: $${cum.toFixed(2)} • <strong>Balance: $${bal.toFixed(2)}</strong></div></div>`;
    });
  }

  // quick stats
  const qs = document.getElementById('quickStats');
  const totalTrades = trades.length;
  const totalWins = trades.filter(t=>t.result==='Win').length;
  const winrate = totalTrades ? ((totalWins/totalTrades)*100).toFixed(1) : 0;
  const totalPL = trades.reduce((s,t)=>s + (Number(t.pl)||0), 0);
  qs.innerHTML = `<div class="small muted">Trades: ${totalTrades} • Win rate: ${winrate}% • Total P/L: $${totalPL.toFixed(2)}</div>`;

  // equity chart
  const labels = []; const data = []; let cum = 0;
  trades.slice().sort((a,b)=>new Date(a.entryTime)-new Date(b.entryTime)).forEach(t=>{
    cum += Number(t.pl||0);
    labels.push(new Date(t.entryTime).toLocaleDateString());
    data.push(cum.toFixed(2));
  });
  const ctx = document.getElementById('equityChart').getContext('2d');
  if(window._equityChart) window._equityChart.destroy();
  window._equityChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Cumulative P/L', data, borderColor:'#00c6ff', backgroundColor:'rgba(0,198,255,0.12)', fill:true }]}, options:{ responsive:true, plugins:{legend:{display:false}} } });

  // today
  const todayKey = new Date().toISOString().slice(0,10);
  const todayTrades = trades.filter(t=> (t.entryTime || '').slice(0,10) === todayKey );
  document.getElementById('todayStats').innerText = `${todayTrades.length} trade(s) today`;
  document.getElementById('todayList').innerHTML = todayTrades.slice(0,5).map(t=>`${t.pair} • ${t.side} • $${(t.pl||0).toFixed(2)}`).join('<br>') || '<span class="small muted">no trades yet</span>';
}

/* ========= News ========= */
document.getElementById('newsForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const d = document.getElementById('newsDate').value || new Date().toISOString().slice(0,10);
  const txt = document.getElementById('newsText').value.trim();
  let img = '';
  const file = document.getElementById('newsImg').files[0];
  if(file) img = await toBase64(file);
  news.push({ id: uid('nw_'), date: d, text: txt, img });
  saveAll(); document.getElementById('newsForm').reset(); renderNews();
});
function renderNews(){
  const el = document.getElementById('newsList'); el.innerHTML='';
  if(news.length===0){ el.innerHTML='<div class="small muted">No news.</div>'; return; }
  news.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach(n=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${n.date}</strong></div><div><button class="ghost" onclick="deleteNews('${n.id}')">Delete</button></div></div>
      <div style="margin-top:8px">${n.text||''}</div>${n.img?`<div style="margin-top:8px"><img src="${n.img}" style="max-width:220px;border-radius:8px"></div>`:''}`;
    el.appendChild(card);
  });
}
function deleteNews(id){ news = news.filter(n=>n.id!==id); saveAll(); renderNews(); }

/* ========= Exports ========= */
function flattenTrade(t){
  return {
    id: t.id,
    account: (accounts.find(a=>a.id===t.accountId) || {}).name || '',
    pair: t.pair,
    entryTime: t.entryTime,
    exitTime: t.exitTime,
    side: t.side,
    tradeType: t.tradeType,
    strategy: t.strategy,
    confluences: t.confluences,
    pl: t.pl,
    result: t.result,
    duration_minutes: (t.entryTime && t.exitTime) ? Math.round(minutesBetween(t.entryTime,t.exitTime)) : ''
  };
}
function tradesToCSV(arr){
  const headers = ['id','account','pair','entryTime','exitTime','side','tradeType','strategy','confluences','pl','result','duration_minutes'];
  const rows = arr.map(t => headers.map(h=> `"${String((flattenTrade(t))[h] ?? '').replace(/"/g,'""')}"`).join(','));
  return `"${headers.join('","')}"\n` + rows.join('\n');
}
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function exportAllCSV(){ if(!trades.length) return alert('No trades to export'); downloadBlob(tradesToCSV(trades),'trades_all.csv','text/csv;charset=utf-8;'); }
function exportAllXLSX(){ if(!trades.length) return alert('No trades to export'); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(trades.map(flattenTrade)); XLSX.utils.book_append_sheet(wb,ws,'Trades'); XLSX.writeFile(wb,'trades_all.xlsx'); }
function exportMonthCSV(){ const now=new Date(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==now.getFullYear()&&new Date(t.entryTime).getMonth()==now.getMonth()); if(!arr.length) return alert('No trades in this month'); downloadBlob(tradesToCSV(arr),`trades_${now.getFullYear()}_${now.getMonth()+1}.csv`,'text/csv;charset=utf-8;'); }
function exportMonthXLSX(){ const now=new Date(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==now.getFullYear()&&new Date(t.entryTime).getMonth()==now.getMonth()); if(!arr.length) return alert('No trades in this month'); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(arr.map(flattenTrade)); XLSX.utils.book_append_sheet(wb,ws,'MonthTrades'); XLSX.writeFile(wb,`trades_${now.getFullYear()}_${now.getMonth()+1}.xlsx`); }
function exportSelectedMonthCSV(year, monthName){ const mi=new Date(`${monthName} 1`).getMonth(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==year&&new Date(t.entryTime).getMonth()==mi); if(!arr.length) return alert('No trades for that month'); downloadBlob(tradesToCSV(arr),`trades_${year}_${mi+1}.csv`,'text/csv;charset=utf-8;'); }
function exportSelectedMonthXLSX(year, monthName){ const mi=new Date(`${monthName} 1`).getMonth(); const arr=trades.filter(t=>new Date(t.entryTime).getFullYear()==year&&new Date(t.entryTime).getMonth()==mi); if(!arr.length) return alert('No trades for that month'); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(arr.map(flattenTrade)); XLSX.utils.book_append_sheet(wb,ws,'MonthTrades'); XLSX.writeFile(wb,`trades_${year}_${mi+1}.xlsx`); }

/* ========= Show today's trades helper ========= */
function showTodayInJournal(){
  openTab('journal');
  setTimeout(()=>renderJournal(true),120);
}

/* ========= Utility: Base64 file reader ========= */
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ========= Image modal close ========= */
function closeModal(){ document.getElementById('imgModal').style.display='none'; }

/* ========= Init ========= */
(function init(){
  // migrate legacy / ensure dates & arrays
  trades.forEach(t=>{
    if(!t.entryTime || isNaN(new Date(t.entryTime))) t.entryTime = t.createdAt || new Date().toISOString();
    if(!Array.isArray(t.screenshots) && t.screenshot){ t.screenshots = [t.screenshot]; }
    if(!Array.isArray(t.screenshots)) t.screenshots = [];
  });

  populateTradeAccounts();
  ensureJournalFilter();
  renderAccounts();
  renderDashboard();
  renderJournal(true);
  renderNews();
  renderScreenshotsByDay();
  populateReportAccounts();

  const rm = document.getElementById('reportMonth'); if(rm) rm.value = new Date().toISOString().slice(0,7);
  initDropzone([]);
})();
</script>
</body>
</html>
